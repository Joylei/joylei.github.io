<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    <!-- Enable responsiveness on mobile devices-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

    <title>Lei&#x27;s Blog - Build EJDB2 on Windows</title>

    
    <link rel="alternate"
        type="application/atom+xml"
        title="RSS" href="https://blog.dotone.top/atom.xml">
    

    <script defer src="https://blog.dotone.top/vendor/instant.page-5.1.0.js" type="module"></script>
    <script defer src="https://blog.dotone.top/vendor/medium-zoom.min.js"
        onload="mediumZoom(document.querySelectorAll('div.post-content img'), { background: '#f8f5f5'});">
    </script>
    <script defer src="https://blog.dotone.top/vendor/slideout-1.0.1.min.js"></script>
    

    <script defer src="https://blog.dotone.top/vendor/katex@0.10.0/katex.min.js">
    </script>
    <script defer src="https://blog.dotone.top/vendor/katex@0.10.0/mathtex-script-type.min.js">
    </script>
    
    <script defer src="https://blog.dotone.top/vendor/katex@0.10.0/auto-render.min.js"
        onload="renderMathInElement(document.body);"></script>
    
    

    
    
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-177611810-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'UA-177611810-1');
</script>


    

    

    
    <link rel="stylesheet" href="https://blog.dotone.top/site.css">
    
    <link rel="stylesheet" href="https://blog.dotone.top/vendor/katex@0.10.0/katex.min.css">
    
    

    
    
</head>

<body>
    <div class="container">

        <div id="mobile-navbar" class="mobile-navbar">
            <div class="mobile-header-logo">
                <a href="/" class="logo">Lei&#x27;s Blog</a>
            </div>
            <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left" itemscope
            itemtype="http://schema.org/SiteNavigationElement">
            <ul class="mobile-menu-list">
                
                <li class="mobile-menu-item">
                    <a itemprop="url" href="https:&#x2F;&#x2F;blog.dotone.top">
                        <span itemprop="name">Home</span>
                    </a>
                </li>
                
                <li class="mobile-menu-item">
                    <a itemprop="url" href="https:&#x2F;&#x2F;blog.dotone.top&#x2F;categories">
                        <span itemprop="name">Categories</span>
                    </a>
                </li>
                
                <li class="mobile-menu-item">
                    <a itemprop="url" href="https:&#x2F;&#x2F;blog.dotone.top&#x2F;tags">
                        <span itemprop="name">Tags</span>
                    </a>
                </li>
                
                <li class="mobile-menu-item">
                    <a itemprop="url" href="https:&#x2F;&#x2F;blog.dotone.top&#x2F;about">
                        <span itemprop="name">About</span>
                    </a>
                </li>
                
            </ul>
        </nav>

        <header id="header">
            <div class="logo"><a href="https:&#x2F;&#x2F;blog.dotone.top">Lei&#x27;s Blog</a></div>
            <nav class="menu" itemscope itemtype="http://schema.org/SiteNavigationElement">
                <ul>
                    
                    <li>
                        <a itemprop="url" href="https:&#x2F;&#x2F;blog.dotone.top">
                            <span itemprop="name">Home</span>
                        </a>
                    </li>
                    
                    <li>
                        <a itemprop="url" href="https:&#x2F;&#x2F;blog.dotone.top&#x2F;categories">
                            <span itemprop="name">Categories</span>
                        </a>
                    </li>
                    
                    <li>
                        <a itemprop="url" href="https:&#x2F;&#x2F;blog.dotone.top&#x2F;tags">
                            <span itemprop="name">Tags</span>
                        </a>
                    </li>
                    
                    <li>
                        <a itemprop="url" href="https:&#x2F;&#x2F;blog.dotone.top&#x2F;about">
                            <span itemprop="name">About</span>
                        </a>
                    </li>
                    
                </ul>
            </nav>
        </header>

        <main>
            <div class="content" id="mobile-panel">
                


<div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
            <ul>
                
                <li>
                    <a href="https://blog.dotone.top/blog/it/build-ejdb2-on-windows/#an-zhuang-huan-jing" class="toc-link">安装环境</a>
                    
                </li>
                
                <li>
                    <a href="https://blog.dotone.top/blog/it/build-ejdb2-on-windows/#bian-yi" class="toc-link">编译</a>
                    
                </li>
                
                <li>
                    <a href="https://blog.dotone.top/blog/it/build-ejdb2-on-windows/#xiu-fu-yun-xing-bao-cuo" class="toc-link">修复运行报错</a>
                    
                </li>
                
                <li>
                    <a href="https://blog.dotone.top/blog/it/build-ejdb2-on-windows/#yi-shang-bai-zuo-liao" class="toc-link">以上白做了</a>
                    
                </li>
                
                <li>
                    <a href="https://blog.dotone.top/blog/it/build-ejdb2-on-windows/#jing-tai-lian-jie" class="toc-link">静态链接</a>
                    
                </li>
                
                <li>
                    <a href="https://blog.dotone.top/blog/it/build-ejdb2-on-windows/#dong-tai-lian-jie" class="toc-link">动态链接</a>
                    
                </li>
                
                <li>
                    <a href="https://blog.dotone.top/blog/it/build-ejdb2-on-windows/#zui-hou" class="toc-link">最后</a>
                    
                </li>
                
                <li>
                    <a href="https://blog.dotone.top/blog/it/build-ejdb2-on-windows/#can-kao" class="toc-link">参考</a>
                    
                </li>
                
            </ul>
        </nav>
    </div>
</div>


<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <h1 class="post__title" itemprop="headline">
        <a href="https:&#x2F;&#x2F;blog.dotone.top&#x2F;blog&#x2F;it&#x2F;build-ejdb2-on-windows&#x2F;">Build EJDB2 on Windows</a>
    </h1>
    
<div class="post__meta">
    <svg style="margin-bottom:-3px" class="i-clock" viewBox="0 0 32 32" width="16" height="16" fill="none"
        stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
        <circle cx="16" cy="16" r="14" />
        <path d="M16 8 L16 16 20 20" />
    </svg>
    <span>6 minute read</span>
    
    <svg style="margin-bottom: -3px" class="i-edit" viewBox="0 0 32 32" width="16" height="16" fill="none"
        stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
        <path d="M30 7 L25 2 5 22 3 29 10 27 Z M21 6 L26 11 Z M5 22 L10 27 Z" />
    </svg>
    <span class="post__time">Published: 2021-01-22</span>
    
    
</div>

    <div class="post-content" itemprop="articleBody">
        <p>最近在给<a href="http://ejdb.org">EJDB2</a>写<a href="https://github.com/Joylei/ejdb2-rs"><code>rust</code>的绑定</a>。本文记录怎么在 Windows 下编译及正常运行<code>EJDB2</code>。
直接到文章末尾看结论。</p>
<h2 id="an-zhuang-huan-jing">安装环境</h2>
<p>参考官方文档安装<code>msys2</code>、<code>mingw64</code>。
安装开发工具链：</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>pacman -S --needed base-devel git vim \
</span><span>      mingw-w64-x86_64-toolchain \
</span></code></pre>
<h2 id="bian-yi">编译</h2>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">cmake</span><span> ..</span><span style="color:#bf616a;"> -DCMAKE_C_COMPILER</span><span>=gcc</span><span style="color:#bf616a;"> -DCMAKE_BUILD_TYPE</span><span>=Release</span><span style="color:#bf616a;"> -DCMAKE_INSTALL_PREFIX</span><span>=./output</span><span style="color:#bf616a;"> -DBUILD_SHARED_LIBS</span><span>=OFF</span><span style="color:#bf616a;"> -DENABLE_HTTP</span><span>=OFF
</span><span style="color:#bf616a;">make
</span><span style="color:#bf616a;">make</span><span> install
</span></code></pre>
<p>直接编译不通过。</p>
<ul>
<li><code>mmap</code>的问题
<code>iowow</code>项目中本身有<code>mman</code>相关代码<code>platform\win32\mman</code>，并且配置了一个<code>CMakeLists.txt</code>来导入<code>mman/mman.c</code>源代码，但是这个<code>CMakeLists.txt</code>没有生效，导致不能编译。
在<code>platform\win32\win32.c</code>中添加</li>
</ul>
<pre data-lang="c" style="background-color:#2b303b;color:#c0c5ce;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#b48ead;">#include </span><span>&quot;</span><span style="color:#a3be8c;">mman/mman.c</span><span>&quot;
</span></code></pre>
<ul>
<li>找不到<code>localtime_r</code>
将<code>log\iwlog.c</code>文件中的<code>localtime_r(&amp;ts_sec, &amp;timeinfo)</code>修改为<code>localtime_s(&amp;timeinfo,&amp;ts_sec)</code></li>
</ul>
<pre data-lang="c" style="background-color:#2b303b;color:#c0c5ce;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#b48ead;">#ifndef</span><span> _WIN32
</span><span>  </span><span style="color:#bf616a;">localtime_r</span><span>(&amp;ts_sec, &amp;timeinfo);
</span><span style="color:#b48ead;">#else
</span><span>  </span><span style="color:#bf616a;">localtime_s</span><span>(&amp;timeinfo, &amp;ts_sec);
</span><span style="color:#b48ead;">#endif
</span></code></pre>
<p>注意：<code>localtime_s</code>和<code>localtime_r</code>的参数的顺序是相反的。</p>
<ul>
<li><code>strndup</code>的问题
链接时加上<code>iberty</code>依赖，不需要改代码。如果不想加上<code>iberty</code>依赖，自己定义一个<code>strndup</code>:</li>
</ul>
<pre data-lang="c" style="background-color:#2b303b;color:#c0c5ce;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#b48ead;">char </span><span>*</span><span style="color:#8fa1b3;">strndup</span><span>(</span><span style="color:#b48ead;">const char </span><span>*</span><span style="color:#bf616a;">src</span><span>, size_t </span><span style="color:#bf616a;">len</span><span>)
</span><span>{
</span><span>  </span><span style="color:#b48ead;">char </span><span>*dst = </span><span style="color:#d08770;">NULL</span><span>;
</span><span>  </span><span style="color:#b48ead;">if </span><span>(src)
</span><span>  {
</span><span>    size_t src_len = </span><span style="color:#96b5b4;">strlen</span><span>(src);
</span><span>    </span><span style="color:#b48ead;">int</span><span> count = </span><span style="color:#bf616a;">min</span><span>(src_len, </span><span style="color:#bf616a;">max</span><span>(len, </span><span style="color:#d08770;">0</span><span>));
</span><span>    dst = </span><span style="color:#96b5b4;">malloc</span><span>(count + </span><span style="color:#d08770;">1</span><span>);
</span><span>    </span><span style="color:#b48ead;">if </span><span>(dst)
</span><span>    {
</span><span>      </span><span style="color:#96b5b4;">strncpy</span><span>(dst, src, count);
</span><span>      dst[count] = &#39;</span><span style="color:#96b5b4;">\0</span><span>&#39;;
</span><span>    }
</span><span>  }
</span><span>  </span><span style="color:#b48ead;">return</span><span> dst;
</span><span>}
</span></code></pre>
<p>做完以上修改，应该可以编译通过了。</p>
<h2 id="xiu-fu-yun-xing-bao-cuo">修复运行报错</h2>
<p>运行编译好的可执行程序，运行报错：</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>ERROR iwkv.c:3590 70007|22|0|Threading error with errno status set. (IW_ERROR_THREADING_ERRNO)|Invalid argument
</span></code></pre>
<p><code>example</code>代码一样报错。</p>
<p>虽然可以知道是哪个文件报错，但是 rc 返回值可能来自很多地方，看代码不能直接定位到具体出错的地方。<code>70007</code>在代码中代表<code>pthread</code>相关错误，所以应该是<code>pthread</code>某个函数调用出错了。</p>
<p>搜索之后发现这个错误<code>Invalid argument</code>是函数验证参数时抛出的错误。
于是想用<code>_set_invalid_parameter_handler</code>来<code>hook</code>出错的位置。代码如下：</p>
<pre data-lang="rs" style="background-color:#2b303b;color:#c0c5ce;" class="language-rs "><code class="language-rs" data-lang="rs"><span style="color:#b48ead;">use </span><span>libc::</span><span style="color:#b48ead;">c_void</span><span>;
</span><span>
</span><span style="color:#b48ead;">type </span><span>FPHandler = Option&lt;
</span><span>    unsafe </span><span style="color:#b48ead;">extern </span><span>&quot;</span><span style="color:#a3be8c;">C</span><span>&quot; </span><span style="color:#b48ead;">fn</span><span>(
</span><span>        expr: </span><span style="color:#b48ead;">*const u16</span><span>,
</span><span>        func: </span><span style="color:#b48ead;">*const u16</span><span>,
</span><span>        file: </span><span style="color:#b48ead;">*const u16</span><span>,
</span><span>        line: </span><span style="color:#b48ead;">u32</span><span>,
</span><span>        pReserved: c_void,
</span><span>    ),
</span><span>&gt;;
</span><span>
</span><span style="color:#b48ead;">extern </span><span>&quot;</span><span style="color:#a3be8c;">system</span><span>&quot; {
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">_set_invalid_parameter_handler</span><span>(</span><span style="color:#bf616a;">fp</span><span>: FPHandler);
</span><span>}
</span><span style="color:#b48ead;">unsafe fn </span><span style="color:#8fa1b3;">u16_ptr_to_string</span><span>(</span><span style="color:#bf616a;">ptr</span><span>: </span><span style="color:#b48ead;">*const u16</span><span>) -&gt; OsString {
</span><span>    </span><span style="color:#b48ead;">use </span><span>std::os::windows::ffi::OsStringExt;
</span><span>    </span><span style="color:#b48ead;">let</span><span> len = (</span><span style="color:#d08770;">0</span><span>..).</span><span style="color:#96b5b4;">take_while</span><span>(|&amp;</span><span style="color:#bf616a;">i</span><span>| *ptr.</span><span style="color:#96b5b4;">offset</span><span>(i) != </span><span style="color:#d08770;">0</span><span>).</span><span style="color:#96b5b4;">count</span><span>();
</span><span>    </span><span style="color:#b48ead;">let</span><span> slice = std::slice::from_raw_parts(ptr, len);
</span><span>
</span><span>    OsString::from_wide(slice)
</span><span>}
</span><span style="color:#b48ead;">unsafe extern </span><span>&quot;</span><span style="color:#a3be8c;">C</span><span>&quot; </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">my_handler</span><span>(
</span><span>    </span><span style="color:#bf616a;">expr</span><span>: </span><span style="color:#b48ead;">*const u16</span><span>,
</span><span>    </span><span style="color:#bf616a;">func</span><span>: </span><span style="color:#b48ead;">*const u16</span><span>,
</span><span>    </span><span style="color:#bf616a;">file</span><span>: </span><span style="color:#b48ead;">*const u16</span><span>,
</span><span>    </span><span style="color:#bf616a;">line</span><span>: </span><span style="color:#b48ead;">u32</span><span>,
</span><span>    </span><span style="color:#bf616a;">pReserved</span><span>: c_void,
</span><span>) {
</span><span>    </span><span style="color:#b48ead;">use </span><span>std::ffi::{OsStr, OsString};
</span><span>
</span><span>    </span><span style="color:#b48ead;">let</span><span> expr = </span><span style="color:#96b5b4;">u16_ptr_to_string</span><span>(expr);
</span><span>    </span><span style="color:#b48ead;">let</span><span> func = </span><span style="color:#96b5b4;">u16_ptr_to_string</span><span>(func);
</span><span>    </span><span style="color:#b48ead;">let</span><span> file = </span><span style="color:#96b5b4;">u16_ptr_to_string</span><span>(file);
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">expr: </span><span style="color:#d08770;">{}</span><span>&quot;, expr.</span><span style="color:#96b5b4;">to_str</span><span>().</span><span style="color:#96b5b4;">unwrap_or_default</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">func: </span><span style="color:#d08770;">{}</span><span>&quot;, func.</span><span style="color:#96b5b4;">to_str</span><span>().</span><span style="color:#96b5b4;">unwrap_or_default</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">file: </span><span style="color:#d08770;">{}</span><span>&quot;, file.</span><span style="color:#96b5b4;">to_str</span><span>().</span><span style="color:#96b5b4;">unwrap_or_default</span><span>());
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">line: </span><span style="color:#d08770;">{}</span><span>&quot;, line);
</span><span>    panic!(&quot;</span><span style="color:#a3be8c;">invalid parameter</span><span>&quot;)
</span><span>}
</span><span>
</span><span style="color:#65737e;">//hook
</span><span style="color:#b48ead;">unsafe </span><span>{
</span><span>    </span><span style="color:#96b5b4;">_set_invalid_parameter_handler</span><span>(Some(my_handler));
</span><span>}
</span></code></pre>
<p>但是没有起作用。</p>
<p>试了<code>GDB</code> 调试，不太会用，放弃了。</p>
<p>接下来使用<code>IDA</code>单步调试，跟踪到具体函数为<code>rci = pthread_condattr_setclock(&amp;cattr, CLOCK_MONOTONIC)</code>。
查看<a href="https://github.com/msys2-contrib/mingw-w64/blob/78dca70d9c2c355f0aaea3292e0d68c57ad7a5c5/mingw-w64-libraries/winpthreads/src/cond.c">pthread_condattr_setclock 的实现</a>，发现第二个参数<code>clock_id</code>只接受<code>0</code>，而在<code>iowow</code>代码中有定义<code>#define CLOCK_MONOTONIC 1</code>。最简单的做法，在这里条件判断一下传入<code>0</code>。但是根本原因是<code>CMakeLists.txt</code>判断<code>HAVE_CLOCK_MONOTONIC</code>出问题了，判断的相关代码：</p>
<pre data-lang="cmake" style="background-color:#2b303b;color:#c0c5ce;" class="language-cmake "><code class="language-cmake" data-lang="cmake"><span style="color:#bf616a;">check_symbol_exists</span><span>(</span><span style="color:#bf616a;">CLOCK_MONOTONIC </span><span>time.h </span><span style="color:#bf616a;">HAVE_CLOCK_MONOTONIC</span><span>)
</span><span style="color:#b48ead;">if </span><span>(HAVE_CLOCK_MONOTONIC)
</span><span>  </span><span style="color:#96b5b4;">add_definitions</span><span>(-DIW_HAVE_CLOCK_MONOTONIC)
</span><span style="color:#b48ead;">endif</span><span>()
</span></code></pre>
<p><code>time.h</code>里面确实没有<code>CLOCK_MONOTONIC</code>，不明白哪里有问题。改成下面的代码：</p>
<pre data-lang="cmake" style="background-color:#2b303b;color:#c0c5ce;" class="language-cmake "><code class="language-cmake" data-lang="cmake"><span style="color:#bf616a;">check_symbol_exists</span><span>(</span><span style="color:#bf616a;">CLOCK_MONOTONIC </span><span>time.h </span><span style="color:#bf616a;">HAVE_CLOCK_MONOTONIC</span><span>)
</span><span style="color:#b48ead;">if </span><span>(HAVE_CLOCK_MONOTONIC and WIN32)
</span><span>  </span><span style="color:#96b5b4;">add_definitions</span><span>(-DIW_HAVE_CLOCK_MONOTONIC)
</span><span>  </span><span style="color:#96b5b4;">message</span><span>(INFO &quot;</span><span style="color:#a3be8c;">HAVE_CLOCK_MONOTONIC=1</span><span>&quot;)
</span><span style="color:#b48ead;">endif</span><span>()
</span></code></pre>
<h2 id="yi-shang-bai-zuo-liao">以上白做了</h2>
<p>最后发现以上白做了，只需要安装<code>mingw-w64-x86_64-cmake</code>：</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>pacman -S --needed base-devel git vim \
</span><span>      mingw-w64-x86_64-toolchain \
</span><span>      mingw-w64-x86_64-cmake
</span></code></pre>
<p>然后在<code>mingw64</code>的 shell 执行：</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">cmake</span><span> ..</span><span style="color:#bf616a;"> -G </span><span>&quot;</span><span style="color:#a3be8c;">MSYS Makefiles</span><span>&quot;</span><span style="color:#bf616a;"> -DCMAKE_C_COMPILER</span><span>=gcc</span><span style="color:#bf616a;"> -DCMAKE_BUILD_TYPE</span><span>=Release</span><span style="color:#bf616a;"> -DCMAKE_INSTALL_PREFIX</span><span>=./output</span><span style="color:#bf616a;"> -DBUILD_SHARED_LIBS</span><span>=OFF</span><span style="color:#bf616a;"> -DENABLE_HTTP</span><span>=OFF
</span><span style="color:#bf616a;">make
</span><span style="color:#bf616a;">make</span><span> install
</span></code></pre>
<p>不需要改动任何代码就可以正常编译和运行。</p>
<h2 id="jing-tai-lian-jie">静态链接</h2>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">cmake</span><span> ..</span><span style="color:#bf616a;"> -G </span><span>&quot;</span><span style="color:#a3be8c;">MSYS Makefiles</span><span>&quot;</span><span style="color:#bf616a;"> -DCMAKE_C_COMPILER</span><span>=gcc</span><span style="color:#bf616a;"> -DCMAKE_BUILD_TYPE</span><span>=Release</span><span style="color:#bf616a;"> -DCMAKE_INSTALL_PREFIX</span><span>=./output</span><span style="color:#bf616a;"> -DBUILD_SHARED_LIBS</span><span>=OFF</span><span style="color:#bf616a;"> -DENABLE_HTTP</span><span>=OFF
</span><span style="color:#bf616a;">make
</span><span style="color:#bf616a;">make</span><span> install
</span></code></pre>
<p>自己的项目静态链接需要链接以下库文件：</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>ejdb2-2
</span><span>iowow-1
</span><span>iberty
</span><span>winpthread
</span><span>mingwex
</span><span>mingw32
</span><span>gcc
</span><span>msvcrt
</span></code></pre>
<h2 id="dong-tai-lian-jie">动态链接</h2>
<ul>
<li>
<p>修改 <code>cmake/modules/AddIOWOW.cmake</code>， 把<code>-DBUILD_SHARED_LIBS=OFF</code> 改为<code>-DBUILD_SHARED_LIBS=${BUILD_SHARED_LIBS}</code>。</p>
</li>
<li>
<p>使用自定义<code>toolchain</code>，用<code>mingw64</code>里的工具导出<code>dll</code>和相关定义文件</p>
</li>
</ul>
<pre data-lang="cmake" style="background-color:#2b303b;color:#c0c5ce;" class="language-cmake "><code class="language-cmake" data-lang="cmake"><span style="color:#65737e;">#my-win64-tc.cmake
</span><span style="color:#b48ead;">if </span><span>(WIN32)
</span><span>    </span><span style="color:#96b5b4;">add_custom_target</span><span>(wintools_init)
</span><span>
</span><span>    </span><span style="color:#96b5b4;">macro</span><span>(</span><span style="color:#8fa1b3;">add_w32_importlib </span><span>tgt libname wdir)
</span><span>    </span><span style="color:#96b5b4;">add_custom_command</span><span>(
</span><span>        </span><span style="color:#bf616a;">TARGET </span><span>${</span><span style="color:#bf616a;">tgt</span><span>}
</span><span>        </span><span style="color:#bf616a;">POST_BUILD
</span><span>        </span><span style="color:#bf616a;">COMMAND </span><span>dlltool.exe -d ${</span><span style="color:#bf616a;">libname</span><span>}.def  -e ${</span><span style="color:#bf616a;">libname</span><span>}.exp -l ${</span><span style="color:#bf616a;">libname</span><span>}.lib -D ${</span><span style="color:#bf616a;">libname</span><span>}.dll
</span><span>        </span><span style="color:#bf616a;">WORKING_DIRECTORY </span><span>${</span><span style="color:#bf616a;">wdir</span><span>}
</span><span>    )
</span><span>    </span><span style="color:#96b5b4;">endmacro</span><span>(add_w32_importlib)
</span><span style="color:#b48ead;">endif</span><span>()
</span></code></pre>
<ul>
<li>编译</li>
</ul>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">cmake</span><span> ..</span><span style="color:#bf616a;"> -G </span><span>&quot;</span><span style="color:#a3be8c;">MSYS Makefiles</span><span>&quot;</span><span style="color:#bf616a;"> -DCMAKE_C_COMPILER</span><span>=gcc</span><span style="color:#bf616a;"> -DCMAKE_BUILD_TYPE</span><span>=Release</span><span style="color:#bf616a;"> -DCMAKE_INSTALL_PREFIX</span><span>=./output</span><span style="color:#bf616a;"> -DBUILD_SHARED_LIBS</span><span>=ON</span><span style="color:#bf616a;"> -DENABLE_HTTP</span><span>=OFF</span><span style="color:#bf616a;"> -DCMAKE_TOOLCHAIN_FILE</span><span>=my-win64-tc.cmake
</span><span style="color:#bf616a;">make
</span><span style="color:#bf616a;">make</span><span> install
</span></code></pre>
<p>自己的项目动态链接需要链接以下库文件：</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>libejdb2
</span><span>libwow
</span></code></pre>
<h2 id="zui-hou">最后</h2>
<p>ejdb2 rust binding: <a href="https://github.com/Joylei/ejdb2-rs">https://github.com/Joylei/ejdb2-rs</a></p>
<h2 id="can-kao">参考</h2>
<ul>
<li><a href="https://www.cnblogs.com/oloroso/p/12632412.html">https://www.cnblogs.com/oloroso/p/12632412.html</a></li>
<li><a href="https://github.com/Softmotions/ejdb/blob/master/WINDOWS.md">https://github.com/Softmotions/ejdb/blob/master/WINDOWS.md</a></li>
</ul>

    </div>

    
    

    <div class="post-footer">
        
        
        <div class="post-tags">
            
            <a href="https://blog.dotone.top/tags/mingw/">#mingw</a>
            
            <a href="https://blog.dotone.top/tags/ejdb/">#ejdb</a>
            
            <a href="https://blog.dotone.top/tags/nosql/">#nosql</a>
            
            <a href="https://blog.dotone.top/tags/windows/">#windows</a>
            
        </div>
        
        

        
    </div>

    
    
    <section id="utterances-comments">
        <script src="https://utteranc.es/client.js" repo="Joylei/joylei.github.io" issue-term="pathname"
            theme="preferred-color-scheme" crossorigin="anonymous" async>
            </script>
    </section>
    
    
</article>


            </div>
        </main>

        
        
    </div>

    
    <script type="text/javascript" src="https://blog.dotone.top/even.js"></script>
    
</body>

</html>